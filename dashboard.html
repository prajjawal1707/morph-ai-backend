<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MORPH-AI-ERA â€¢ Dashboard</title>

    <!-- Icons & Plotly -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

    <style>
        :root {
            --bg: #0f1115;
            --panel: #1b1f2a;
            --panel-2: #111521;
            --muted: #9aa4b2;
            --text: #e7ecf3;
            --brand: #1E90FF;
            --ok: #28a745;
            --warn: #f59e0b;
            --danger: #ef4444;
            --chip: #0d1320;
            --chip-border: #293245;
            --card-shadow: 0 8px 28px rgba(0, 0, 0, .35);
            --radius: 14px;
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, Apple Color Emoji, Segoe UI Emoji;
        }

        /* ===== Shell ===== */
        .wrap {
            display: flex;
            min-height: 100dvh;
            gap: 18px;
        }

        /* ===== Sidebar ===== */
        .sidebar {
            position: sticky;
            top: 0;
            left: 0;
            height: 100vh;
            width: 70px;
            background: var(--panel-2);
            border-right: 1px solid #202533;
            padding: 14px 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: width 0.25s ease;
            overflow: hidden;
        }

        .sidebar.expanded {
            width: 220px;
            align-items: flex-start;
        }

        .brand {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: #0c1a33;
            border: 1px solid #1b2a44;
            color: var(--brand);
            font-weight: 700;
            margin-bottom: 20px;
            cursor: pointer;
        }

        .brand span {
            margin-left: 10px;
            font-size: 18px;
            font-weight: 700;
            white-space: nowrap;
            display: none;
        }

        .sidebar.expanded .brand span {
            display: inline;
        }

        .nav {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
        }

        .navbtn {
            width: 100%;
            height: 44px;
            border-radius: 12px;
            border: 1px solid #1e2534;
            background: #0e1422;
            color: #a9b3c3;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 0 12px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }

        .navbtn span {
            display: none;
        }

        .sidebar.expanded .navbtn span {
            display: inline;
        }


        /* ===== Content ===== */
        .content {
            flex: 1;
            padding: 20px;
        }

        .placeholder {
            margin-top: 50px;
            font-size: 1.5rem;
            text-align: center;
            color: #a9b3c3;
        }

        /* ===== Main ===== */
        .main {
            flex: 1;
            padding: 24px 24px 40px
        }

        .title {
            text-align: center;
            margin: 0 0 6px 0;
            font-size: 40px;
            font-weight: 800;
            letter-spacing: .2px;
            color: #cfe5ff;
            text-shadow: 0 2px 40px rgba(30, 144, 255, .15);
        }

        .subtitle {
            text-align: center;
            color: var(--muted);
            margin: 0 0 24px 0
        }

        /* ===== Metric cards ===== */
        .metrics {
            display: grid;
            grid-template-columns: repeat(4, minmax(240px, 1fr));
            gap: 18px;
            margin-bottom: 18px;
        }

        .card {
            background: linear-gradient(180deg, var(--panel), var(--panel-2));
            border: 1px solid #212735;
            border-radius: var(--radius);
            padding: 18px 20px;
            box-shadow: var(--card-shadow);
        }

        .metric-label {
            color: #9fb1c7;
            font-size: 14px
        }

        .metric-val {
            font-size: 28px;
            font-weight: 800;
            color: #67b2ff;
            margin-top: 8px
        }

        /* ===== Control bar (universal) ===== */
        .bar {
            background: linear-gradient(180deg, #121722, #0e1421);
            border: 1px solid #1f2736;
            border-radius: var(--radius);
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 18px;
        }

        .group {
            display: flex;
            align-items: center;
            gap: 10px
        }

        .label {
            color: #c8d2e0;
            font-size: 14px
        }

        .select,
        .btn,
        .chip {
            height: 36px;
            border-radius: 10px;
            border: 1px solid #263048;
            background: #12192b;
            color: #e6edf6;
            padding: 0 12px;
            font-size: 14px;
        }

        .select {
            appearance: none;
            padding-right: 26px;
            position: relative;
            background-image: linear-gradient(45deg, transparent 50%, #7f8aa0 50%), linear-gradient(135deg, #7f8aa0 50%, transparent 50%);
            background-position: calc(100% - 16px) 50%, calc(100% - 11px) 50%;
            background-size: 6px 6px, 6px 6px;
            background-repeat: no-repeat;
        }

        .btn {
            cursor: pointer;
            border-color: #2a3956;
            background: #17345c
        }

        .btn:hover {
            filter: brightness(1.07)
        }

        .btn.primary {
            background: #1E90FF;
            border-color: #2579d8;
            color: #001527;
            font-weight: 700
        }

        .btn.success {
            background: var(--ok);
            border-color: #1d8a36;
            color: #02140a;
            font-weight: 700
        }

        .chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: var(--chip);
            border-color: var(--chip-border);
            color: #c5d2e6;
        }

        .chip .x {
            cursor: pointer;
            color: #94a1b8
        }

        .chip .x:hover {
            color: #e5ecf7
        }

        input[type="file"] {
            display: none
        }

        .file-label {
            border: 1px dashed #2d3a54;
            background: #12192b;
            color: #cfe1ff;
            padding: 8px 12px;
            border-radius: 10px;
            cursor: pointer;
            height: 36px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        /* ===== Grid charts ===== */
        .grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(320px, 1fr));
            gap: 18px;
        }

        .panel {
            position: relative
        }

        .panel .head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
            color: #cfd8e6;
            font-weight: 700;
        }

        .panel .head .controls {
            display: flex;
            gap: 10px;
            align-items: center
        }

        .plot {
            width: 100%;
            height: 340px;
            border-radius: 12px;
            border: 1px solid #202a3a;
            background: linear-gradient(180deg, #101625, #0c121f);
            overflow: hidden;
        }

        /* ===== Footer pills ===== */
        .links {
            display: flex;
            gap: 10px;
            margin-top: 12px
        }

        .pill {
            padding: 6px 10px;
            border-radius: 8px;
            border: 1px solid #1f2937;
            background: #0c1424;
            color: #bcd0ea;
            text-decoration: none;
            font-size: 13px;
        }

        .pill:hover {
            border-color: #2b3c55;
            color: #e9f2ff
        }

        @media (max-width:1100px) {
            .metrics {
                grid-template-columns: repeat(2, 1fr)
            }

            .grid {
                grid-template-columns: 1fr
            }
        }
    </style>
</head>

<body>
    <div class="wrap">

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="brand" id="toggleSidebar">MAE <span>MORPH-AI-ERA</span></div>
            <nav class="nav">
                <button class="navbtn" data-page="dashboard"><i
                        class="fa-solid fa-gauge-high"></i><span>Dashboard</span></button>
                <button class="navbtn" data-page="analytics"><i
                        class="fa-solid fa-chart-line"></i><span>Analytics</span></button>
                <button class="navbtn" data-page="history"><i
                        class="fa-regular fa-clock"></i><span>History</span></button>
            </nav>
            <div class="spacer"></div>
            <nav class="nav">
                <button class="navbtn" data-page="settings"><i
                        class="fa-solid fa-gear"></i><span>Settings</span></button>
                <button class="navbtn" data-page="profile"><i class="fa-regular fa-user"></i><span>Profile</span>
                </button>
            </nav>
        </aside>

        <script>
            // toggle sidebar
            toggleSidebar.addEventListener("click", () => {
                sidebar.classList.toggle("expanded");
            });

            // nav buttons
            document.querySelectorAll(".navbtn").forEach(btn => {
                btn.addEventListener("click", () => {
                    const page = btn.getAttribute("data-page");
                    if (page === "dashboard") {
                        content.innerHTML = `<h1>Welcome to Dashboard</h1><p>This is your main dashboard area.</p>`;
                    } else {
                        content.innerHTML = `<div class="placeholder">âš¡ ${page.toUpperCase()} will be updated soon</div>`;
                    }
                });
            });

        </script>


        <script>
            const content = document.getElementById("content");

            document.querySelectorAll(".navbtn").forEach(btn => {
                btn.addEventListener("click", () => {
                    const page = btn.getAttribute("data-page");
                    if (page === "dashboard") {
                        content.innerHTML = `<h1>Welcome to Dashboard</h1><p>This is your main dashboard area.</p>`;
                    } else {
                        content.innerHTML = `<div class="placeholder">âš¡ ${page.toUpperCase()} will be updated soon</div>`;
                    }
                });
            });
        </script>
        <div id="root"></div>
        <!-- MAIN -->
        <main class="main">
            <h1 class="title">Welcome to MORPH-AI-ERA</h1>
            <p class="subtitle">Dashboard Overview</p>

            <!-- METRIC CARDS -->
            <section class="metrics">
                <div class="card">
                    <div class="metric-label">Total Sales</div>
                    <div id="m-total" class="metric-val">$0</div>
                </div>
                <div class="card">
                    <div class="metric-label">Average Profit</div>
                    <div id="m-avg" class="metric-val">$0</div>
                </div>
                <div class="card">
                    <div class="metric-label">Max Profit</div>
                    <div id="m-max" class="metric-val">$0</div>
                </div>
                <div class="card">
                    <div class="metric-label">Min Profit</div>
                    <div id="m-min" class="metric-val">$0</div>
                </div>
            </section>

            <!-- UNIVERSAL CONTROL BAR (includes the file uploader you asked for) -->
            <section class="bar">
                <!-- Upload -->
                <div class="group">
                    <span class="label">Upload CSV</span>
                    <label for="fileInput" class="file-label"><i class="fa-solid fa-file-arrow-up"></i> Choose
                        File</label>
                    <input id="fileInput" type="file" accept=".csv,.xlsx,.xls" />
                </div>

                <!-- Loaded pill -->
                <div id="loadedChip" class="chip" style="display:none">
                    <i class="fa-regular fa-file-lines"></i>
                    <span id="loadedName">demo.csv</span>
                    <span class="x" id="clearLoaded" title="Clear">Ã—</span>
                </div>

                <!-- Spacing -->
                <div style="flex:1"></div>

                <!-- Universal selects -->
                <div class="group">
                    <span class="label">Chart Type</span>
                    <select id="u-type" class="select">
                        <option value="line">Line</option>
                        <option value="bar">Bar</option>
                        <option value="area">Area</option>
                    </select>
                </div>
                <div class="group">
                    <span class="label">Metric</span>
                    <select id="u-metric" class="select">
                        <option value="Sales">Sales</option>
                        <option value="Profit">Profit</option>
                        <option value="Net_Profit_%">Net_Profit_%</option>
                    </select>
                </div>

                <button id="btnUpdate" class="btn primary"><i class="fa-solid fa-rotate"></i>&nbsp;Update Chart</button>
                <button id="btnCalc" class="btn success"><i class="fa-solid fa-calculator"></i>&nbsp;Calculate
                    Metrics</button>
            </section>

            <!-- MAIN CHART (big) -->
            <section class="card panel" style="padding:14px 14px 6px">
                <div class="head"><span>Main Chart</span></div>
                <div id="main-plot" class="plot"></div>
            </section>

            <!-- 2x2 GRID CHARTS -->
            <section class="grid" style="margin-top:18px">
                <!-- Sales Trend -->
                <div class="card panel">
                    <div class="head">
                        <span>Sales Trend</span>
                        <div class="controls">
                            <select id="st-type" class="select">
                                <option value="line">Line</option>
                                <option value="bar">Bar</option>
                                <option value="area">Area</option>
                            </select>
                            <select id="st-metric" class="select">
                                <option value="Sales">Sales</option>
                                <option value="Profit">Profit</option>
                                <option value="Net_Profit_%">Net_Profit_%</option>
                            </select>
                        </div>
                    </div>
                    <div id="sales-trend" class="plot"></div>
                </div>

                <!-- Profit Trend -->
                <div class="card panel">
                    <div class="head">
                        <span>Profit Trend</span>
                        <div class="controls">
                            <select id="pt-type" class="select">
                                <option value="bar">Bar</option>
                                <option value="line">Line</option>
                                <option value="area">Area</option>
                            </select>
                            <select id="pt-metric" class="select">
                                <option value="Profit">Profit</option>
                                <option value="Sales">Sales</option>
                                <option value="Net_Profit_%">Net_Profit_%</option>
                            </select>
                        </div>
                    </div>
                    <div id="profit-trend" class="plot"></div>
                </div>

                <!-- Overlay -->
                <div class="card panel">
                    <div class="head">
                        <span>Sales vs Profit (Overlay)</span>
                        <div class="controls">
                            <select id="ovl-type-a" class="select">
                                <option value="line">Line</option>
                                <option value="bar">Bar</option>
                                <option value="area">Area</option>
                            </select>
                            <select id="ovl-type-b" class="select">
                                <option value="bar">Bar</option>
                                <option value="line">Line</option>
                                <option value="area">Area</option>
                            </select>
                        </div>
                    </div>
                    <div id="overlay-plot" class="plot"></div>
                </div>

                <!-- Scatter -->
                <div class="card panel">
                    <div class="head">
                        <span>Sales vs Profit (Scatter)</span>
                        <div class="controls">
                            <button id="sc-refresh" class="btn"><i
                                    class="fa-solid fa-arrows-rotate"></i>&nbsp;Refresh</button>
                        </div>
                    </div>
                    <div id="scatter-plot" class="plot"></div>
                </div>
            </section>

            <!-- Small footer links -->
            <div class="links">
                <a class="pill" href="https://plotly.com/javascript/" target="_blank" rel="noreferrer">Plotly Docs</a>
                <a class="pill" href="https://fastapi.tiangolo.com/" target="_blank" rel="noreferrer">FastAPI Docs</a>
            </div>
        </main>
    </div>
    <!-- 
  <script>
    // ---------- helpers ----------
    const $ = (q) => document.querySelector(q);
    const fmtMoney = (n) => '$' + (Number(n || 0).toLocaleString(undefined, { maximumFractionDigits: 2 }));

    const endpoints = {
      summary: '/api/summary',
      chart: '/api/chart',
      upload: '/api/upload'
    };

    async function apiGet(url) {
      const r = await fetch(url);
      if (!r.ok) throw new Error(`GET ${url} ${r.status}`);
      return r.json();
    }
    async function apiPost(url, payload) {
      const r = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload || {})
      });
      if (!r.ok) throw new Error(`POST ${url} ${r.status}`);
      return r.json();
    }

    // ---------- file upload pill ----------
    const fileInput = $('#fileInput');
    const loadedChip = $('#loadedChip');
    const loadedName = $('#loadedName');
    const clearLoaded = $('#clearLoaded');

    fileInput.addEventListener('change', async (e) => {
      const f = e.target.files[0];
      if (!f) return;
      const fd = new FormData();
      fd.append('file', f);
      try {
        const res = await fetch(endpoints.upload, { method: 'POST', body: fd });
        if (!res.ok) { alert('Upload failed'); return; }
        const data = await res.json();
        loadedName.textContent = data.filename || f.name;
        loadedChip.style.display = 'inline-flex';
        await refreshAll();
      } catch (err) {
        console.error(err); alert('Upload failed');
      }
    });

    clearLoaded.addEventListener('click', () => {
      // UI only clear (backend keeps last file as cache per your service)
      loadedChip.style.display = 'none';
      loadedName.textContent = '';
    });

    // ---------- metrics ----------
    async function loadSummary() {
      try {
        const s = await apiGet(endpoints.summary);
        // supports both your latest summary + extended ones if you add them
        $('#m-total').textContent = fmtMoney(s.total_sales ?? 0);
        $('#m-avg').textContent = fmtMoney(s.avg_profit ?? 0);
        $('#m-max').textContent = fmtMoney(s.max_profit ?? 0);
        $('#m-min').textContent = fmtMoney(s.min_profit ?? 0);
      } catch (err) {
        console.warn('summary', err);
        $('#m-total').textContent = '$0';
        $('#m-avg').textContent = '$0';
        $('#m-max').textContent = '$0';
        $('#m-min').textContent = '$0';
      }
    }

    // ---------- chart utils ----------
    function makeTrace(type, x, y, name) {
      const base = { x, y, name, hovertemplate: `<b>%{y}</b><extra>${name || ''}</extra>` };
      if (type === 'bar') return { type: 'bar', marker: {}, ...base };
      if (type === 'area') return { type: 'scatter', mode: 'lines', fill: 'tozeroy', ...base };
      return { type: 'scatter', mode: 'lines+markers', ...base }; // line
    }
    const layoutBase = (title) => ({
      title: { text: title, font: { size: 16, color: '#dbe7ff' } },
      paper_bgcolor: '#0c121f',
      plot_bgcolor: '#0c121f',
      margin: { l: 40, r: 16, t: 40, b: 40 },
      xaxis: { gridcolor: '#1d2738', zeroline: false, tickfont: { color: '#b9c7dd' } },
      yaxis: { gridcolor: '#1d2738', zeroline: false, tickfont: { color: '#b9c7dd' } },
      showlegend: true,
      legend: { orientation: 'h', y: -.22, font: { color: '#cbd6ea' } },
    });

    async function fetchSeries(metric) {
      const data = await apiPost(endpoints.chart, { metric });
      // fallback if backend returns image (older version) â€” ignore image and try arrays
      const labels = data.labels ?? data.x ?? [];
      const values = data.values ?? data.y ?? [];
      return { labels, values };
    }

    // ---------- main chart ----------
    async function drawMain() {
      const type = $('#u-type').value;
      const metric = $('#u-metric').value;
      const { labels, values } = await fetchSeries(metric);
      const trace = makeTrace(type, labels, values, metric);
      const layout = layoutBase(`${metric} Over Time`);
      Plotly.react('main-plot', [trace], layout, { responsive: true, displayModeBar: true });
    }

    // ---------- subpanels ----------
    async function drawSalesTrend() {
      const type = $('#st-type').value;
      const metric = $('#st-metric').value;
      const { labels, values } = await fetchSeries(metric);
      Plotly.react('sales-trend', [makeTrace(type, labels, values, metric)], layoutBase(`${metric} Trend`), { responsive: true });
    }
    async function drawProfitTrend() {
      const type = $('#pt-type').value;
      const metric = $('#pt-metric').value;
      const { labels, values } = await fetchSeries(metric);
      Plotly.react('profit-trend', [makeTrace(type, labels, values, metric)], layoutBase(`${metric} Trend`), { responsive: true });
    }
    async function drawOverlay() {
      // overlay Sales + Profit with two different styles
      const typeA = $('#ovl-type-a').value; // Sales
      const typeB = $('#ovl-type-b').value; // Profit
      const a = await fetchSeries('Sales');
      const b = await fetchSeries('Profit');
      const traces = [
        makeTrace(typeA, a.labels, a.values, 'Sales'),
        makeTrace(typeB, b.labels, b.values, 'Profit')
      ];
      const layout = layoutBase('Sales vs Profit (Overlay)');
      Plotly.react('overlay-plot', traces, layout, { responsive: true });
    }
    async function drawScatter() {
      // x: Sales, y: Profit
      const a = await fetchSeries('Sales');
      const b = await fetchSeries('Profit');
      const len = Math.min(a.values.length, b.values.length);
      const x = a.values.slice(0, len);
      const y = b.values.slice(0, len);
      const trace = {
        type: 'scatter', mode: 'markers',
        x, y,
        marker: { size: 8 },
        name: 'Sales vs Profit',
        hovertemplate: 'Sales: %{x}<br>Profit: %{y}<extra></extra>'
      };
      const layout = layoutBase('Sales vs Profit (Scatter)');
      Plotly.react('scatter-plot', [trace], layout, { responsive: true });
    }

    async function refreshAll() {
      await loadSummary();
      await Promise.all([
        drawMain(),
        drawSalesTrend(),
        drawProfitTrend(),
        drawOverlay(),
        drawScatter()
      ]);
    }

    // ---------- wire up ----------
    $('#btnUpdate').addEventListener('click', async () => {
      await drawMain();
    });
    $('#btnCalc').addEventListener('click', async () => {
      await loadSummary();
      alert('Metrics recalculated from current dataset.');
    });

    // panel listeners
    $('#st-type').addEventListener('change', drawSalesTrend);
    $('#st-metric').addEventListener('change', drawSalesTrend);
    $('#pt-type').addEventListener('change', drawProfitTrend);
    $('#pt-metric').addEventListener('change', drawProfitTrend);
    $('#ovl-type-a').addEventListener('change', drawOverlay);
    $('#ovl-type-b').addEventListener('change', drawOverlay);
    $('#sc-refresh').addEventListener('click', drawScatter);

    // boot
    (async () => { await refreshAll(); })();
  </script>
</body>

</html> -->













    <script>
        // ---------- DOM Elements & Helpers ----------
        const $ = (q) => document.querySelector(q);
        const $$ = (q) => document.querySelectorAll(q);
        const fmtMoney = (n) => '$' + (Number(n || 0).toLocaleString(undefined, { maximumFractionDigits: 2 }));
        const endpoints = { summary: '/api/summary', chart: '/api/chart', upload: '/api/upload' };

        let AVAILABLE_METRICS = { numeric: [], categorical: [] };

        // ---------- API Communication ----------
        async function apiPost(url, payload) {
            // We will send a default empty metric to avoid 422 if payload is incomplete
            const body = { metric: '', type: '', ...payload };
            const r = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            if (!r.ok) throw new Error(`POST ${url} ${r.status}`);
            return r.json();
        }
        async function apiGet(url) {
            const r = await fetch(url);
            if (!r.ok) throw new Error(`GET ${url} ${r.status}`);
            return r.json();
        }

        // ---------- File Upload Logic ----------
        $('#fileInput').addEventListener('change', async (e) => {
            const f = e.target.files[0];
            if (!f) return;
            const fd = new FormData();
            fd.append('file', f);
            try {
                const res = await fetch(endpoints.upload, { method: 'POST', body: fd });
                if (!res.ok) { alert('Upload failed (server error)'); return; }
                const data = await res.json();
                $('#loadedName').textContent = data.filename || f.name;
                $('#loadedChip').style.display = 'inline-flex';
                await refreshAll();
            } catch (err) {
                console.error(err);
                alert('Upload failed (network error)');
            }
        });

        // ---------- UI Update Functions ----------
        function populateDropdowns(summary) {
            const numericOptions = summary.numeric_columns.map(c => `<option value="${c}">${c}</option>`).join('');
            const categoricalOptions = summary.categorical_columns.map(c => `<option value="${c}">${c}</option>`).join('');

            // Populate all metric dropdowns
            $$('#u-metric, #st-metric, #pt-metric').forEach(sel => {
                sel.innerHTML = `
                <optgroup label="Numeric">${numericOptions}</optgroup>
                <optgroup label="Categorical">${categoricalOptions}</optgroup>
            `;
            });
        }

        async function loadSummary() {
            try {
                const s = await apiGet(endpoints.summary);
                AVAILABLE_METRICS = { numeric: s.numeric_columns || [], categorical: s.categorical_columns || [] };

                // Update metric cards
                $('#m-total').textContent = fmtMoney(s.total_sales);
                $('#m-avg').textContent = fmtMoney(s.avg_profit);
                $('#m-max').textContent = fmtMoney(s.max_profit);
                $('#m-min').textContent = fmtMoney(s.min_profit);

                // Update dropdowns with available columns
                populateDropdowns(s);
            } catch (err) {
                console.error('summary', err);
                // Reset UI on failure
            }
        }

        // ---------- Chart Drawing Logic (SMART VERSION) ----------
        const plotlyLayout = (title) => ({
            title: { text: title, font: { size: 16, color: '#dbe7ff' } },
            paper_bgcolor: '#0c121f', plot_bgcolor: '#0c121f', margin: { l: 40, r: 16, t: 40, b: 40 },
            xaxis: { gridcolor: '#1d2738', zeroline: false, tickfont: { color: '#b9c7dd' } },
            yaxis: { gridcolor: '#1d2738', zeroline: false, tickfont: { color: '#b9c7dd' } },
            showlegend: true, legend: { orientation: 'h', y: -.22, font: { color: '#cbd6ea' } },
        });
        const showPlotMessage = (plotId, message) => {
            $(`#${plotId}`).innerHTML = `<div style="text-align:center; padding-top:100px; color:var(--muted);">${message}</div>`;
        };

        async function fetchSeries(metric, type) {
            const { labels, values } = await apiPost(endpoints.chart, { metric, type });
            return { labels, values };
        }

        // **FEATURE: Main Chart will always try to draw something**
        async function drawMain() {
            const allMetrics = [...AVAILABLE_METRICS.numeric, ...AVAILABLE_METRICS.categorical];
            if (allMetrics.length === 0) {
                showPlotMessage('main-plot', 'No plottable data found in the file.');
                return;
            }

            const metric = $('#u-metric').value || allMetrics[0]; // Pick first available if none selected
            const type = $('#u-type').value;
            const { labels, values } = await fetchSeries(metric, type);
            const trace = { type, x: labels, y: values, name: metric };
            Plotly.react('main-plot', [trace], plotlyLayout(`${metric} Over Time`), { responsive: true });
        }

        // **FEATURE: Other charts will show a message if data is not available**
        async function drawSalesTrend() {
            if (!AVAILABLE_METRICS.numeric.includes('Sales')) {
                showPlotMessage('sales-trend', '"Sales" column not found in data.');
                return;
            }
            const { labels, values } = await fetchSeries('Sales', $('#st-type').value);
            Plotly.react('sales-trend', [{ type: $('#st-type').value, x: labels, y: values, name: 'Sales' }], plotlyLayout('Sales Trend'), { responsive: true });
        }

        async function drawProfitTrend() {
            if (!AVAILABLE_METRICS.numeric.includes('Profit')) {
                showPlotMessage('profit-trend', '"Profit" column not found in data.');
                return;
            }
            const { labels, values } = await fetchSeries('Profit', $('#pt-type').value);
            Plotly.react('profit-trend', [{ type: $('#pt-type').value, x: labels, y: values, name: 'Profit' }], plotlyLayout('Profit Trend'), { responsive: true });
        }
        // Is poore function ko naye waale se replace karein
        async function drawOverlay() {
            if (!AVAILABLE_METRICS.numeric.includes('Sales') || !AVAILABLE_METRICS.numeric.includes('Profit')) {
                showPlotMessage('overlay-plot', '"Sales" and "Profit" columns are required for this chart.');
                return;
            }

            // YEH LINES THEEK KI GAYI HAIN
            const typeA = $('#ovl-type-a').value; // Sales ka type
            const typeB = $('#ovl-type-b').value; // Profit ka type

            const [sales, profit] = await Promise.all([
                fetchSeries('Sales', typeA),    // Ab hum type bhej rahe hain
                fetchSeries('Profit', typeB)   // Ab hum type bhej rahe hain
            ]);

            const traces = [
                { type: typeA, x: sales.labels, y: sales.values, name: 'Sales' },
                { type: typeB, x: profit.labels, y: profit.values, name: 'Profit' }
            ];
            Plotly.react('overlay-plot', traces, plotlyLayout('Sales vs Profit'), { responsive: true });
        }

        // Is poore function ko bhi naye waale se replace karein
        async function drawScatter() {
            if (!AVAILABLE_METRICS.numeric.includes('Sales') || !AVAILABLE_METRICS.numeric.includes('Profit')) {
                showPlotMessage('scatter-plot', '"Sales" and "Profit" columns are required for this chart.');
                return;
            }

            // YEH LINES THEEK KI GAYI HAIN
            const [sales, profit] = await Promise.all([
                fetchSeries('Sales', 'line'),   // Scatter ke liye hum default 'line' type bhej denge
                fetchSeries('Profit', 'line')  // taaki backend data bhej de
            ]);

            const trace = { type: 'scatter', mode: 'markers', x: sales.values, y: profit.values, name: 'Sales vs Profit' };
            Plotly.react('scatter-plot', [trace], plotlyLayout('Sales vs Profit (Scatter)'), { responsive: true });
        }
        // ---------- Main Controller ----------
        async function refreshAll() {
            await loadSummary();
            // This will now run all drawing functions. They will either draw a chart or a message.
            await Promise.allSettled([
                drawMain(),
                drawSalesTrend(),
                drawProfitTrend(),
                drawOverlay(),
                drawScatter()
            ]);
        }

        // ---------- Event Listeners ----------
        $('#btnUpdate').addEventListener('click', drawMain);
        $$('#st-type, #st-metric').forEach(el => el.addEventListener('change', drawSalesTrend));
        $$('#pt-type, #pt-metric').forEach(el => el.addEventListener('change', drawProfitTrend));
        $$('#ovl-type-a, #ovl-type-b').forEach(el => el.addEventListener('change', drawOverlay));
        $('#sc-refresh').addEventListener('click', drawScatter);

        // Initial load
        (async () => { await refreshAll(); })();
    </script>
</body>

</html>